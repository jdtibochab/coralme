name: Python Package Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  pypi:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # https://raw.githubusercontent.com/actions/python-versions/main/versions-manifest.json
        python-version: [3.8.18, 3.9.25, 3.10.19, 3.11.14, 3.12.12, 3.13.9, 3.14.0]
        # python-version: [3.14.0]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        id: setup_primary
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
        continue-on-error: true

      - name: Download and compile python ${{ matrix.python-version }}
        if: steps.setup_primary.outcome == 'failure'
        run: |
          apt-get install -y python3-pip python3-tk python3-h5py build-essential \
            checkinstall libssl-dev zlib1g-dev libncurses5-dev libffi-dev \
            libncursesw5-dev libreadline-dev libsqlite3-dev libgdbm-dev \
            libdb5.3-dev libbz2-dev libexpat1-dev liblzma-dev tk-dev uuid-dev > /dev/null

          mkdir -p /opt/ubuntu-software

          wget https://www.python.org/ftp/python/${{ matrix.python-version }}/Python-${{ matrix.python-version }}.tgz -O /opt/ubuntu-software/Python-${{ matrix.python-version }}.tgz  > /dev/null 2> /dev/null
          if [ -d /opt/Python-${{ matrix.python-version }} ]; then rm -rf /opt/Python-${{ matrix.python-version }}; fi
          tar xvzf /opt/ubuntu-software/Python-${{ matrix.python-version }}.tgz -C /opt > /dev/null
          cd /opt/Python-${{ matrix.python-version }}
          #if [ -f Makefile ]; then make clean; fi
          if [ -d /opt/python-${{ matrix.python-version }} ]; then rm -rf /opt/python-${{ matrix.python-version }}; fi
          ./configure --prefix=/opt/python-${{ matrix.python-version }} --with-ensurepip=install --with-pymalloc > /dev/null
          make > /dev/null 2> /dev/null
          make install > /dev/null
          rm -rf /opt/Python-${{ matrix.python-version }}

          export PATH=/opt/python-${{ matrix.python-version }}:$PATH

      - name: Install NCBI BLAST+
        run: |
          apt-get update > /dev/null 2> /dev/null
          apt-get install -y ncbi-blast+ > /dev/null 2> /dev/null

      - name: Install dependencies
        run: |
          apt-get install -y cmake swig gfortran libgfortran5 libglpk-dev libopenblas-dev > /dev/null 2> /dev/null

      - name: Install coralME
        run: |
          pip3 install --quiet --editable .

      - name: Run pytest
        run: |
          pytest > /dev/null 2> /dev/null

      - name: Summary
        if: ${{ always() }}
        run: |
          echo "${{ matrix.python-version }} â†’ ${{ job.status }}"
